# iOS 26 睡眠评分功能 - 修改清单

## 📋 总体概述
为iOS 26用户添加苹果原生睡眠评分支持，实现与传统睡眠时长+效率评估的"二选一"逻辑。

---

## 🔥 **READINESS模块 - 需要修改的文件**

### 1. **mapping.py** - ⚠️ 关键文件
**状态**: 部分完成（只改了1处，还有1处未改）

**已完成**：
- ✅ 第23-45行：已添加iOS 26优先检查逻辑
- ✅ 第49行：有基线时跳过传统sleep_performance计算

**❌ 待修改**：
- 🚨 **第194行附近**：无基线用户的固定阈值计算逻辑
  ```python
  if 'sleep_performance_state' not in raw_inputs:  # 这里也需要加iOS 26检查
  ```

**修改内容**：
- 在第194行前添加iOS 26检查，跳过传统计算
- 确保iOS 26用户始终优先使用苹果评分

---

### 2. **constants.py** - ✅ 已完成
**状态**: 已完成

**已完成**：
- ✅ 添加`apple_sleep_score` CPT表（5级评分）
- ✅ 添加权重配置（0.95，高于传统0.90）

---

### 3. **engine.py** - ⚠️ 需要验证
**状态**: 理论上自动支持，但需要测试

**潜在问题**：
- 🤔 如果同时有`apple_sleep_score`和`sleep_performance`会如何处理？
- 🤔 权重是否会叠加导致睡眠因子权重过高？

**需要验证**：
- 测试iOS 26用户输入是否正确处理
- 确认不会同时使用两套睡眠评分

---

### 4. **service.py** - ⚠️ 需要扩展输入处理
**状态**: 需要修改

**问题**：
- 当前只处理传统字段，不处理`ios_version`和`apple_sleep_score`
- 需要在payload处理中添加这两个字段

**需要修改**：
- 在`compute_readiness_from_payload`中添加iOS 26字段处理
- 确保这些字段传递到evidence中

---

### 5. **示例和文档文件** - ❌ 需要更新
**状态**: 完全过时

**需要更新的文件**：
- `examples/male_request.json`
- `examples/female_request.json`  
- `examples/user_history_*.csv`
- `README.md`

**更新内容**：
- 添加iOS 26示例请求格式
- 更新API文档说明二选一逻辑
- 创建iOS 26用户的示例数据

---

## 🔥 **BASELINE模块 - 需要修改的文件**

### 1. **service.py** - ⚠️ 需要支持iOS 26
**状态**: 需要修改

**问题**：
- iOS 26用户可能仍需要个人基线做参考
- 苹果评分与个人基线的结合策略未定义

**需要考虑**：
- 是否需要基于个人基线调整苹果评分阈值？
- iOS 26用户的基线计算是否需要特殊处理？

---

### 2. **healthkit_integration.py** - ⚠️ 需要添加iOS 26支持
**状态**: 需要修改

**需要添加**：
- iOS 26睡眠评分数据获取接口
- 版本检测逻辑
- 数据格式转换

---

### 3. **examples/\*.py** - ❌ 需要更新
**状态**: 需要更新所有示例

**需要更新**：
- 所有集成示例添加iOS 26支持
- 演示二选一逻辑的使用方法

---

## 🔥 **输入格式和API问题**

### 1. **输入字段标准化** - ⚠️ 关键问题
**当前问题**：
- 所有文档写的是`sleep_performance_state`
- 但mapping.py中某些地方直接设置`sleep_performance`（无_state后缀）
- iOS 26新增字段：`ios_version`, `apple_sleep_score`

**需要统一**：
- 明确字段命名规范
- 更新所有示例和文档
- 确保向后兼容

### 2. **API兼容性** - ⚠️ 向后兼容
**需要确保**：
- 老用户（iOS < 26）完全不受影响
- 新用户（iOS >= 26）可以选择使用苹果评分或传统评分
- 优雅的fallback机制

---

## 🎯 **修改优先级**

### Phase 1: 核心功能修复 🚨
1. **修复mapping.py第194行** - 无基线用户的iOS 26支持
2. **验证engine.py处理逻辑** - 测试实际计算流程
3. **扩展service.py输入处理** - 支持新字段

### Phase 2: 集成和测试 ⚠️
4. **更新baseline模块** - iOS 26基线集成策略
5. **创建测试用例** - 验证二选一逻辑
6. **处理边界情况** - 同时有两套评分时的行为

### Phase 3: 文档和示例 📝
7. **更新所有示例文件** - JSON/CSV格式
8. **更新API文档** - 说明新字段和逻辑
9. **创建迁移指南** - 帮助用户升级

---

## ⚡ **测试验证计划**

### 测试场景：
1. **老用户（iOS < 26）** - 完全使用传统逻辑
2. **新用户有苹果评分** - 使用苹果评分，跳过传统计算
3. **新用户无苹果评分** - fallback到传统逻辑
4. **异常处理** - 苹果评分解析失败时的行为
5. **个性化基线** - iOS 26 + 个人基线的组合效果

### 验证标准：
- ✅ 向后兼容：老用户行为不变
- ✅ 功能正确：iOS 26用户能正确使用苹果评分
- ✅ 优雅降级：异常时自动fallback
- ✅ 性能稳定：不影响整体计算性能

---

## 📝 **下一步行动**

1. **立即修复**: mapping.py第194行的iOS 26检查
2. **验证测试**: 创建简单测试用例验证当前逻辑
3. **逐步完善**: 按Phase顺序逐个攻克问题

**预计工作量**: 需要修改8-10个文件，创建5-6个测试用例，更新4-5个文档