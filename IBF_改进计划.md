# IBF 个性化贝叶斯模型改进计划

## 项目概述
本计划旨在将当前的IBF静态专家系统优化为一个强大、鲁棒的"冷启动"贝叶斯模型，为未来的N-of-1个性化学习做好准备。

## 当前状态分析
- **模型类型**: 静态专家系统 (基于预定义CPT概率表)
- **核心问题**: 
  1. CPT中存在0.00和0.95等极端概率值，造成数值不稳定
  2. 硬编码规则破坏了模型统一性
  3. 缺乏证据加权机制
  4. 睡眠指标过于简化

## 改进目标
将当前的朴素贝叶斯系统升级为加权贝叶斯系统，提升模型鲁棒性和智能化程度。

---

## 步骤一：软化CPT中的极端概率 🚀

### 目标
消除数值计算中的不稳定因素，防止概率乘法运算中出现0值

### 具体操作
1. **替换0.00概率**
   - 所有0.00 → 1e-6 (表示"极不可能但仍有可能")
   
2. **降低过高概率**
   - 0.95 → 0.90
   - 0.85 → 0.80
   - 其他高概率值适度降低5%左右

### 影响的数据结构
- `EMISSION_CPT` - 症状指纹库
- `BASELINE_TRANSITION_CPT` - 状态转移概率

### 预期效果
- 消除数值运算中的0乘法风险
- 保留模型的不确定性
- 提升数值稳定性

---

## 步骤二：细化睡眠指标分离 🛏️

### 目标
将单一的`objective_sleep`拆分为更精确的睡眠评估维度

### 具体操作
1. **重命名现有指标**
   - `objective_sleep` → `sleep_performance` (睡眠量化表现)

2. **新增睡眠质量指标**
   - 添加`restorative_sleep`条目到EMISSION_CPT
   - 定义专家概率分布(high/medium/low)

### 新的睡眠评估框架
- **sleep_performance**: 关注睡眠时长、效率等量化指标
- **restorative_sleep**: 关注深度睡眠、恢复质量等定性感受

### 预期效果
- 更精确的睡眠状态评估
- 区分睡眠量和睡眠质量的不同影响

---

## 步骤三：实施证据加权机制 ⚖️

### 目标
从朴素贝叶斯升级为加权贝叶斯，根据证据可靠性分配不同影响力

### 核心升级
1. **创建权重字典**
```python
EVIDENCE_WEIGHTS_FITNESS = {
    'hrv_trend': 1.0,              # 客观核心指标
    'restorative_sleep': 0.95,     # 客观睡眠质量
    'muscle_soreness': 0.9,        # 主观核心指标
    'subjective_stress': 0.85,     # 神经系统恢复
    'subjective_fatigue': 0.8,     # 主观疲劳
    'sleep_performance': 0.7,      # 睡眠时长
    # ... 其他指标
}

证据名称	数据来源类型	所属层级	建议权重 (weight 
i
​
 )	原理与依据
心率变异性 (HRV)	客观/传感器	1	1.0	
自主神经系统(ANS)平衡的主要指标，对恢复度影响最大。   

静息心率 (RHR)	客观/传感器	1	0.95	
心血管健康和恢复状态的核心指标，与HRV同为最重要的因素。   

睡眠表现	客观/传感器	2	0.90	
衡量睡眠债与恢复情况，是比原始睡眠时长更有效的指标。   

恢复性睡眠	客观/传感器	2	0.85	
深度睡眠和REM睡眠是身体修复和精神恢复的关键阶段。   

呼吸频率	客观/传感器	2	0.80	
相对稳定的指标，但其显著偏离是潜在疾病或高压的强信号。   

主观疲劳度	主观/用户输入	3	0.75	
用户对身体状态的直接感知，有价值但存在主观偏差。   

主观压力	主观/用户输入	3	0.70	
心理压力是ANS负荷的重要来源，会直接影响HRV。   

肌肉酸痛度	主观/用户输入	3	0.65	反映训练后的肌肉损伤，但其感知强度因人而异。
主观睡眠质量	主观/用户输入	3	0.60	对睡眠恢复的综合性主观评价，作为客观睡眠指标的补充。
饮酒/疾病	行为/情境	4	N/A (作为标志)	
强大的系统性压力源，应作为覆盖性规则或强先验调节器。   


```

2. **修改贝叶斯更新函数**
   - `run_bayesian_update`接受权重参数
   - 应用权重: `likelihood ** weight`

### 权重设计原则
- 客观数据(HRV) > 核心主观数据 > 一般主观数据
- 对运动员恢复影响大的指标权重更高

### 预期效果
- 模型更智能地权衡不同信息源
- 提升诊断准确性
- 减少噪声数据的干扰

---

## 步骤四：重构硬编码规则 🔄

### 目标
移除`run_bayesian_update`中的非概率性if语句，保持模型统一性

### 当前问题
```python
# 第179-181行的硬编码规则破坏了统一性
if symptom_evidence.get('muscle_soreness') == 'low' and symptom_evidence.get('subjective_stress') == 'high':
    posterior_probs['NFOR'] *= 2.0
    posterior_probs['FOR'] *= 0.5
```

### 解决方案
1. **短期方案**: 移除硬编码，依靠高权重隐式实现
2. **长期方案**: 在CPT中定义交互作用

### 预期效果
- 模型逻辑统一化
- 更优雅的架构设计
- 便于未来扩展

---

## 步骤五：测试和验证 ✅

### 测试策略
1. **数值稳定性测试**
   - 边界值测试 (全0、全1输入)
   - 连续运算测试

2. **逻辑一致性测试**
   - 对比改进前后的诊断结果
   - 验证权重机制有效性

3. **真实场景测试**
   - 使用多组运动员数据验证

### 验证指标
- 数值溢出/下溢检测
- 概率分布有效性
- 诊断逻辑合理性

---

## 实施优先级

### 🚨 立即行动 (最高优先级)
- **步骤一**: 软化CPT极端概率
- **步骤二**: 细化睡眠指标

### 🎯 核心升级 (高优先级)  
- **步骤三**: 实施证据加权机制

### 🔧 清理优化 (中优先级)
- **步骤四**: 重构硬编码规则
- **步骤五**: 测试验证

---

## 技术实施细节

### 数值计算优化
- 使用对数空间计算避免浮点下溢
- 实现数值稳定的概率归一化

### 代码结构改进
- 分离配置和逻辑代码
- 增强可维护性和可扩展性

### 向后兼容性
- 保持现有API接口不变
- 确保用户代码无需修改

---

## 预期成果

### 短期收益 (1-2周)
- ✅ 消除数值不稳定问题
- ✅ 提升诊断准确性
- ✅ 增强模型鲁棒性

### 长期价值 (1-3个月)
- 🎯 构建强大的"冷启动"专家模型
- 🎯 为N-of-1个性化学习奠定基础
- 🎯 支持真实用户部署和数据收集

### 最终目标
**打造一个理想的"阶段0"静态专家系统，为未来的动态个性化模型升级做好充分准备。**

---

## 风险评估和缓解策略

### 主要风险
1. **概率修改可能影响诊断精度**
   - 缓解: 小幅度调整 + 充分测试
   
2. **权重设定缺乏数据支持**
   - 缓解: 基于运动科学理论 + 迭代优化
   
3. **代码重构引入bug**
   - 缓解: 分步实施 + 回归测试

### 质量保证
- 每个步骤完成后进行功能测试
- 保留原版本作为对比基准
- 建立自动化测试用例

---

**版本**: v1.0  
**创建时间**: 2025年9月2日  
**负责人**: Planner & Executor 联合制定  
**下一步行动**: 立即执行步骤一 - 软化CPT中的极端概率